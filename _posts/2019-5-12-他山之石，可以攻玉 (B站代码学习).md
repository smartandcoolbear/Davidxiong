---
title: 他山之石，可以攻玉 (B站代码学习)
layout: post
tags:
  - Golang, bilibili
---


由于众所周知的一些原因，B站代码迫不得已"被开源"了。最近在看B站代码的过程中，也将一些学习心得记录下来。
由于相关的技术点还是比较多的，因此准备分成一个系列来讲，整体提纲如下：
 1. B站代码结构学习
 2. B站典型的中间件/框架学习
 3. B站整体的技术栈分析。
 
今天先讲第一部分：B站代码结构学习。


相关链接：

1.[一探B站后台架构](https://studygolang.com/articles/19995#reply0)


# B站代码结构学习
先贴一张B站的整体代码结构出来：
![](/media/files/2019/05/B站目录结构.png)
在这张结构图中，可以看到几个点：
1. 整体代码结构比较简单，其中app为主要代码目录，build为构建工具以及代码检验的脚本，library为各种基础库建设（如缓存，配置，日志，数据库，服务发现，限流，RPC等）。
2. 有比较规范的版本控制的三剑客——README.MD,CHANGELOG.MD,CONTRIBUTOR.MD,并且在每个子模块中，也必须含有独立的版本控制三剑客。
3. 在.gitlab中，有比较规范的提交规范和MR规范。
4. 代码是托管在自建的gitlab上，但是没有用gitlab-runner来构建，而是用bazel+jenkins的形式。这个应该是B站之前的历史包袱，我觉得用Gitlab-runner还是方便一些。
5. 包管理方案使用的是vendor。

接下来我们再看下/app 目录下的具体结构：
![](/media/files/2019/05/B站:app目录结构.png)
解释说明如下：
1. admin: 后台管理模块
2. common:公共模块，实际上没咋用到
3. infra:各种消息相关的基础服务（canal/config/databus/discovery/notification）
4. interface: 提供对外网关的服务
5. service: 提供RPC的内部服务
6. job:提供异步服务，主要用于处理消息队列
7. tools:提供各种工具，如各种模板生成工具，在这里面就涉及到了bmproto,warden等bili的http框架。 



举例来说，一开始C++中对对象的认识是变量、参量、指针等，因此我们最为常见的函数传参是这样：

    void function(float* x, unsigned n) {
    },
    
其传入的参数基本都是各种变量类型。

然而，随着技术的不断发展，将函数作为参数传入的需求越来越多。因此C++中慢慢延伸出这样的用法：

    int fun1(int i){ 
        return   i; 
    } 
    void fun2(int j, int (*p)(int)){ 
        cout << p(j); 
    } 
    void main() { 
        int   i=1; 
        fun2(i,fun1); 
    } 
    








